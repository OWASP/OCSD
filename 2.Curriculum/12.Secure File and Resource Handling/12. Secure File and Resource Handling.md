# Module 12. Secure File and Resource Handling

## Learning Objectives

After completing this module, developers will be able to:

- Implement secure file upload validation including type, size, and content verification
- Prevent path traversal, Zip Slip, and file inclusion vulnerabilities
- Apply secure file storage and download practices
- Protect against SSRF attacks in file operations

---

## 12.1 File Upload Validation

### Type Validation

- File extension validation
- MIME type verification
- Magic byte/file signature checking
- Content-Type header validation

### Size Validation

- Maximum file size limits
- Request size limits
- Chunked upload handling
- Storage quota enforcement

### Content Validation

- Image dimension validation
- Document structure validation
- Archive content inspection
- Executable content detection

---

## 12.2 MIME Type Validation vs Sniffing

### MIME Type Security

- Server-side MIME type detection
- X-Content-Type-Options: nosniff
- Content-Type response headers
- Preventing MIME confusion attacks

### Validation Best Practices

- Multiple validation layers
- Never trust client-provided MIME type
- Validate actual file content
- Whitelist allowed types

---

## 12.3 Malware Scanning Integration

### Implementation Approaches

- Antivirus API integration
- Sandbox analysis for uploads
- Quarantine workflows
- Asynchronous scanning patterns

### Scanning Considerations

- Scanning before storage
- Periodic re-scanning
- Zero-day protection limitations
- Performance impact management

---

## 12.4 Path Traversal Prevention

### Attack Patterns

- Directory traversal (../)
- Absolute path injection
- Encoded traversal sequences
- Null byte injection

### Prevention Techniques

- Canonicalization of paths
- Whitelist base directories
- Filename sanitization
- Chroot/jail environments

---

## 12.5 Zip Slip Vulnerability Prevention

### Understanding Zip Slip

- Archive extraction vulnerabilities
- Path traversal in archives
- Symlink attacks in archives

### Prevention

- Validate extracted file paths
- Extract to isolated directories
- Check for path traversal in filenames
- Limit extraction depth and file count

---

## 12.6 Using User Input with File Functions

### Secure Path Handling

- Avoid user input in file paths
- Use indirect references (IDs)
- Validate against allowed paths
- Separate storage from web root

### Static vs Dynamic Files

- Static file serving security
- Dynamic file generation
- Temporary file handling
- User paths vs absolute paths

---

## 12.7 Secure File Storage

### Storage Location Security

- Store outside web root
- Use non-guessable filenames
- Implement access controls
- Separate storage by sensitivity

### Cloud Storage Security

- Pre-signed URLs with expiration
- Bucket policies and ACLs
- Encryption at rest
- Access logging

---

## 12.8 Secure File Download Headers

### Security Headers for Downloads

- Content-Disposition: attachment
- X-Content-Type-Options: nosniff
- Content-Type accuracy
- Cache-Control for sensitive files

### Download Security

- Authorization before download
- Download link expiration
- Rate limiting downloads
- Audit logging

---

## 12.9 Temporary File Handling

### Secure Temporary Files

- Secure temporary directories
- Unique filename generation
- Proper permission settings
- Cleanup after use

### Race Condition Prevention

- Atomic file operations
- Exclusive file creation
- Avoiding predictable names

---

## 12.10 Server-Side Request Forgery (SSRF) in File Operations

### SSRF Attack Vectors

- URL-based file fetching
- Image processing from URLs
- Document import features
- Webhook URL validation

### Prevention Techniques

- URL allowlisting
- Protocol restrictions (HTTP/HTTPS only)
- Private IP range blocking
- DNS rebinding protection
- Request timeout limits

---

## 12.11 Remote File Inclusion (RFI) and Local File Inclusion (LFI)

### Understanding the Vulnerabilities

- RFI: Including remote files in execution
- LFI: Including local files in execution
- Log poisoning attacks
- PHP wrapper exploitation

### Prevention Strategies

- Disable remote file includes
- Whitelist includable files
- Input validation for file parameters
- Proper file permission configuration

---

## 12.12 Web Server File Processing

### Secure Ways of Processing Files

- Sandboxed processing environments
- Resource limits for processing
- Timeout enforcement
- Output sanitization

### Configuration Security

- Disable directory listing
- Proper handler configuration
- Execution prevention in upload directories
- Access control for sensitive files
